#### 环境准备

- release-3.2分支源码

#### 描述

设备控制流程涵盖系统多个部分，阅读[MVC分层](MVC分层.md)、[规则引擎](规则引擎.md)、[设备连接](设备连接.md) 、 [数据传输](数据传输.md) 有助于阅读本篇。

#### 分析

官方提供RPC（远程过程调用）功能，可从设备侧发起，也可有服务侧发起，服务侧发起又分为单路（One-way，不需要设备回自己）和双路（Two-way），这里以服务侧发起的双路RPC请求为例。

入口类：`RpcController`，核心流程如下：

```
//RpcController 94
return handleDeviceRPCRequest(false, new DeviceId(UUID.fromString(deviceIdStr)), requestBody);

//RpcController 122
deviceRpcService.processRestApiRpcRequest(rpcRequest, fromDeviceRpcResponse -> reply(new LocalRequestMetaData(rpcRequest, currentUser, result), fromDeviceRpcResponse));

//DefaultTbCoreDeviceRpcService 102
sendRpcRequestToRuleEngine(request);

//DefaultTbCoreDeviceRpcService 171
clusterService.pushMsgToRuleEngine(msg.getTenantId(), msg.getDeviceId(), tbMsg, null);

//DefaultTbClusterService 154
//调用ruleEngineMsgProducer（类型为TbQueueProducer）发送消息
//TbQueueProducer有多种实现，常见的是InMemoryTbQueueProducer和TbKafkaProducerTemplate
producerProvider.getRuleEngineMsgProducer().send(tpi, new TbProtoQueueMsg<>(tbMsg.getId(), msg), callback);

//DefaultTbRuleEngineConsumerService 165
List<TbProtoQueueMsg<ToRuleEngineMsg>> msgs = consumer.poll(pollDuration);

//DefaultTbRuleEngineConsumerService 185
forwardToRuleEngineActor(configuration.getName(), tenantId, toRuleEngineMsg, callback);

//DefaultTbRuleEngineConsumerService 300
msg = new QueueToRuleEngineMsg(tenantId, tbMsg, relationTypes, toRuleEngineMsg.getFailureMessage());
actorContext.tell(msg);

//省略部分Actor过程，可参见规则引擎
//AppActor --> TenantActor --> RuleChainActor --> RuleNodeActor -->TbNode.....

//TbSendRPCRequestNode
//todo

```



示意图如下：

//todo



#### TIPS

- 官方RPC说明 [rpc](https://thingsboard.io/docs/user-guide/rpc/)
- 在一般情况下，反向控制通过网关进行（考虑到网络等因素），官方文档：[what-is-iot-gateway](https://thingsboard.io/docs/iot-gateway/what-is-iot-gateway/)
- https://thingsboard.io/docs/user-guide/integrations/decode/#step-1-connection

