#### 环境准备



#### 描述

官方提供了两种架构，单片架构（Monolithic Architecture）以及微服务架构（Microservices Architecture）用来解决不同数据接入场景的需求：

- 单片架构  ![](../../image/monolithic.png)
- 微服务架构 ![](../../image/msa.png)

单片架构存在单点故障，因此本篇主要探讨如何使用微服务架构或者如何混用微服务架构和单片架构。

微服务架构划分为五类服务，分别是UI服务、Core服务、RuleEngine服务、JsExecutor服务、Transport服务，Transport根据协议划分，分为Mqtt协议服务、Http协议服务、Coap协议服务，可以根据情况进行有选择的部署，甚至是可以和单片架构混合使用。（原因是通过配置项，可以让单片架构程序变为Core服务程序或RuleEngine服务程序）。

##### 高可用场景一：

- 较少设备 <=10000台
- 较少请求 <= 10000条消息/s、10000个数据点/s
- 较少规则链（主要是脚本相关节点较少） 

在这种情况下可使用如下方案达到高可用：
![](../../image/ha1.png)

服务清单如下：

- 2台4核心8G内存，部署HAproxy+Keepalive+VIP
- 2台8核心16G内存，部署Thingsboard Monolithic
- 3台2核心4G内存，部署Redis+Zookeeper
- 3台4核心8g内存，部署PostgreSQL

镜像需求如下：

|   类型   | 名称 | 版本| 说明| 是否必须 |
| ---- | ---- | ---- | ---- | ---- |
|  官方    | thingsboard/tb-node |   3.2.2   |     |    |
|  官方    | thingsboard/tb-mqtt-transport     |  3.2.2    |     |   |
|  官方    | thingsboard/tb-http-transport     |   3.2.2   |     |   |
|  官方    | thingsboard/tb-coap-transport     |   3.2.2   |     |   |
|  官方    | thingsboard/tb-web-ui     |   3.2.2   |     |   |
|  其他    | postgres:11 |   11   |     |   |
|  其他    | bitnami/cassandra |   3.11.6   |     |   |
|  其他    | zookeeper |   3.5.7   |     |   |
|  其他    | kafka     |      |     |   |
|  其他    | redis     |      |     |   |

//todo


#### 系统部署

//todo





#### 时序存储

//todo



#### TIPS

- [Thingsboard架构](https://thingsboard.io/docs/reference/)
- [Thingsboard场景](https://thingsboard.io/docs/reference/iot-platform-deployment-scenarios/)
- https://kubernetes.github.io/ingress-nginx/deploy/baremetal/#over-a-nodeport-service
- PG集群方案
- Redis集群方案

